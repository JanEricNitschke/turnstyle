<!DOCTYPE html>
<html>
<head>
    <title>turnstyle.js</title>
    <script type="text/JavaScript" src="turnstyle.js"></script>
</head>
<body>
    <canvas id="canvas" style="display:none;"></canvas>
    <script>
        let view;

        const evalCtx = {
            inputNumber: () => {
                return new Promise((resolve, reject) => {
                    const form = document.createElement("form");
                    const input = document.createElement("input");
                    input.type = "text";
                    form.appendChild(input);
                    const submit = document.createElement("button");
                    submit.type = "submit";
                    submit.textContent = "submit";
                    form.appendChild(submit);
                    document.body.appendChild(form);

                    form.addEventListener("submit", (event) => {
                        event.preventDefault();
                        const value = input.value;
                        if (value) {
                            document.body.removeChild(form);
                            resolve(Number(value));
                        } else {
                            reject("Input is empty");
                        }
                    });
                });
            },
            onWhnf: async (expr) => {
                await new Promise(r => setTimeout(r, 500));
                view.focus(expr.position, expr.direction);
            }
        }

        const img = new Image();
        img.crossOrigin = "Anonymous";
        img.onload = () => {
            const canvas = document.getElementById("canvas");
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const src = new ImageDataSource(imageData);

            view = new AnnotatedView(document, src);
            document.body.appendChild(view.svg);

            const parser = new Parser(src);
            const expr = parser.parse();
            console.log(expr.whnf(evalCtx));
        };

        img.onerror = (err) => {
            console.error("Failed to load image.");
        };

        img.src = "examples/loop.png";

    </script>
</body>
</html>
